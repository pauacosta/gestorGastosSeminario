# ğŸ“– GUÃA DEL CÃ“DIGO - Para Estudiantes

Esta guÃ­a explica **cÃ³mo funciona el cÃ³digo** del proyecto de forma simple y directa.

---

## ğŸ“‘ Ãndice

1. [app.py - La AplicaciÃ³n Principal](#1-apppy---la-aplicaciÃ³n-principal)
2. [models.py - Las Tablas de la Base de Datos](#2-modelspy---las-tablas-de-la-base-de-datos)
3. [templates - Las PÃ¡ginas HTML](#3-templates---las-pÃ¡ginas-html)
4. [static/style.css - Los Estilos](#4-staticstylecss---los-estilos)
5. [Flujo Completo: Â¿QuÃ© pasa cuando...?](#5-flujo-completo-quÃ©-pasa-cuando)

---

## 1. app.py - La AplicaciÃ³n Principal

Este archivo es el **cerebro** de la aplicaciÃ³n. Controla todo.

### ğŸ”§ ConfiguraciÃ³n Inicial

```python
from flask import Flask, render_template, request, redirect, url_for, flash, session
from models import db, Usuario, Categoria, Gasto

# Crear la app
app = Flask(__name__)

# Configuraciones importantes
app.config['SECRET_KEY'] = 'tu_clave_secreta_aqui'  # Para las sesiones
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///database.db'  # UbicaciÃ³n de la BD
```

**Â¿QuÃ© hace esto?**
- Crea la aplicaciÃ³n Flask
- Define dÃ³nde estÃ¡ la base de datos (archivo `database.db`)
- La SECRET_KEY es para encriptar las sesiones

### ğŸ”’ Crear el Usuario Admin

```python
with app.app_context():
    db.create_all()  # Crea las tablas si no existen
    
    # Crear usuario admin si no existe
    usuario_admin = Usuario.query.filter_by(username='admin').first()
    if not usuario_admin:
        admin = Usuario(username='admin', email='admin@example.com')
        admin.set_password('admin123')
        db.session.add(admin)
        db.session.commit()
```

**Â¿QuÃ© hace esto?**
- Crea las 3 tablas (usuarios, categorias, gastos)
- Si no existe el usuario "admin", lo crea
- La contraseÃ±a se guarda **encriptada** (no en texto plano)

### ğŸ›¡ï¸ Decorador para Proteger Rutas

```python
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:  # Â¿Hay usuario logueado?
            flash('Debes iniciar sesiÃ³n', 'warning')
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function
```

**Â¿QuÃ© hace esto?**
- Es un "candado" para las pÃ¡ginas
- Si no estÃ¡s logueado â†’ te manda al login
- Uso: `@login_required` antes de cada funciÃ³n

### ğŸšª Rutas Principales

#### Login (Inicio de SesiÃ³n)

```python
@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':  # Si enviÃ³ el formulario
        username = request.form.get('username')
        password = request.form.get('password')
        
        # Buscar el usuario en la BD
        usuario = Usuario.query.filter_by(username=username).first()
        
        # Verificar contraseÃ±a
        if usuario and usuario.check_password(password):
            session['user_id'] = usuario.id  # Guardar en sesiÃ³n
            session['username'] = usuario.username
            flash(f'Â¡Bienvenido {username}!', 'success')
            return redirect(url_for('home'))
        else:
            flash('Usuario o contraseÃ±a incorrectos', 'danger')
    
    return render_template('login.html')  # Mostrar formulario
```

**Flujo:**
1. Usuario envÃ­a username y password
2. Busca en la BD
3. Si existe y la contraseÃ±a es correcta â†’ guarda en sesiÃ³n
4. Si no â†’ muestra error

#### Crear Gasto (CON VALIDACIÃ“N)

```python
@app.route('/gastos/crear', methods=['POST'])
@login_required
def crear_gasto():
    categoria_id = request.form.get('categoria_id')
    monto = request.form.get('monto')
    descripcion = request.form.get('descripcion', '')
    
    # âš ï¸ VALIDACIÃ“N 1: CategorÃ­a obligatoria
    if not categoria_id:
        flash('Debes seleccionar una categorÃ­a', 'danger')
        return redirect(url_for('gastos'))
    
    # âš ï¸ VALIDACIÃ“N 2: Monto vÃ¡lido
    try:
        monto = float(monto)
        if monto <= 0:
            raise ValueError
    except (ValueError, TypeError):
        flash('El monto debe ser positivo', 'danger')
        return redirect(url_for('gastos'))
    
    # Crear el gasto
    nuevo_gasto = Gasto(
        categoria_id=categoria_id,
        monto=monto,
        descripcion=descripcion,
        usuario_id=session['user_id']
    )
    
    db.session.add(nuevo_gasto)
    db.session.commit()
    
    flash('Gasto registrado exitosamente', 'success')
    return redirect(url_for('lista_gastos'))
```

**Lo importante:**
- âœ… Valida que la categorÃ­a NO estÃ© vacÃ­a
- âœ… Valida que el monto sea un nÃºmero positivo
- âœ… Asocia el gasto al usuario actual (`session['user_id']`)

### ğŸ“Š PatrÃ³n de ABM (Crear, Editar, Eliminar)

**CREAR:**
```python
@app.route('/categorias/crear', methods=['POST'])
@login_required
def crear_categoria():
    nombre = request.form.get('nombre')
    
    # Verificar que no exista
    if Categoria.query.filter_by(nombre=nombre).first():
        flash('La categorÃ­a ya existe', 'danger')
        return redirect(url_for('categorias'))
    
    # Crear nueva
    nueva = Categoria(nombre=nombre)
    db.session.add(nueva)
    db.session.commit()
    
    flash('CategorÃ­a creada', 'success')
    return redirect(url_for('categorias'))
```

**EDITAR:**
```python
@app.route('/categorias/editar/<int:id>', methods=['POST'])
@login_required
def editar_categoria(id):
    categoria = Categoria.query.get_or_404(id)  # Buscar
    
    categoria.nombre = request.form.get('nombre')  # Actualizar
    db.session.commit()  # Guardar
    
    flash('CategorÃ­a actualizada', 'success')
    return redirect(url_for('categorias'))
```

**ELIMINAR:**
```python
@app.route('/categorias/eliminar/<int:id>')
@login_required
def eliminar_categoria(id):
    categoria = Categoria.query.get_or_404(id)
    
    # Validar que no tenga gastos
    if categoria.gastos:
        flash('No se puede eliminar, tiene gastos asociados', 'danger')
        return redirect(url_for('categorias'))
    
    db.session.delete(categoria)
    db.session.commit()
    
    flash('CategorÃ­a eliminada', 'success')
    return redirect(url_for('categorias'))
```

---

## 2. models.py - Las Tablas de la Base de Datos

Este archivo define las **tablas** como clases de Python.

### ğŸ‘¤ Modelo Usuario

```python
class Usuario(db.Model):
    __tablename__ = 'usuarios'
    
    # Columnas
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(200), nullable=False)
    fecha_creacion = db.Column(db.DateTime, default=datetime.utcnow)
    
    # RelaciÃ³n: Un usuario tiene muchos gastos
    gastos = db.relationship('Gasto', backref='usuario', lazy=True, 
                            cascade='all, delete-orphan')
```

**Columnas importantes:**
- `primary_key=True` â†’ Es el ID Ãºnico
- `unique=True` â†’ No puede haber duplicados
- `nullable=False` â†’ Es obligatorio

**MÃ©todos importantes:**

```python
def set_password(self, password):
    """Guarda la contraseÃ±a encriptada"""
    self.password_hash = generate_password_hash(password)

def check_password(self, password):
    """Verifica si la contraseÃ±a es correcta"""
    return check_password_hash(self.password_hash, password)
```

### ğŸ·ï¸ Modelo CategorÃ­a

```python
class Categoria(db.Model):
    __tablename__ = 'categorias'
    
    id = db.Column(db.Integer, primary_key=True)
    nombre = db.Column(db.String(100), unique=True, nullable=False)
    descripcion = db.Column(db.String(200))
    fecha_creacion = db.Column(db.DateTime, default=datetime.utcnow)
    
    # RelaciÃ³n: Una categorÃ­a tiene muchos gastos
    gastos = db.relationship('Gasto', backref='categoria', lazy=True)
```

### ğŸ’µ Modelo Gasto

```python
class Gasto(db.Model):
    __tablename__ = 'gastos'
    
    id = db.Column(db.Integer, primary_key=True)
    monto = db.Column(db.Float, nullable=False)
    descripcion = db.Column(db.String(200))
    fecha = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Claves forÃ¡neas (conectan con otras tablas)
    categoria_id = db.Column(db.Integer, db.ForeignKey('categorias.id'), 
                            nullable=False)
    usuario_id = db.Column(db.Integer, db.ForeignKey('usuarios.id'), 
                          nullable=False)
```

**Relaciones:**
```
Usuario (1) ----< Gasto (N)  â†’  usuario.gastos
CategorÃ­a (1) ----< Gasto (N)  â†’  categoria.gastos

Gasto pertenece a:
  - gasto.usuario
  - gasto.categoria
```

---

## 3. templates - Las PÃ¡ginas HTML

### ğŸ“„ base.html - La Plantilla Madre

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <title>{% block title %}Gestor de Gastos{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="bootstrap.min.css" rel="stylesheet">
    
    <!-- Nuestro CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Navbar (solo si estÃ¡ logueado) -->
    {% if session.user_id %}
    <nav>...</nav>
    {% endif %}
    
    <!-- Mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    {% endwith %}
    
    <!-- Contenido que cambia -->
    {% block content %}{% endblock %}
</body>
</html>
```

**Conceptos clave:**
- `{% block title %}` â†’ Otras pÃ¡ginas pueden cambiar el tÃ­tulo
- `{% if session.user_id %}` â†’ Solo muestra navbar si estÃ¡ logueado
- `{% block content %}` â†’ AquÃ­ va el contenido de cada pÃ¡gina

### ğŸ“ form.html - Formulario de Gastos

```html
{% extends "base.html" %}

{% block content %}
<form method="POST" action="{{ url_for('crear_gasto') }}" id="formGasto">
    
    <!-- CategorÃ­a (OBLIGATORIO) -->
    <select name="categoria_id" required>
        <option value="">-- Selecciona --</option>
        {% for categoria in categorias %}
        <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
        {% endfor %}
    </select>
    
    <!-- Monto -->
    <input type="number" name="monto" step="0.01" required>
    
    <!-- DescripciÃ³n (opcional) -->
    <textarea name="descripcion"></textarea>
    
    <button type="submit">Guardar</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
// ValidaciÃ³n JavaScript (nivel 2)
document.getElementById('formGasto').addEventListener('submit', function(e) {
    const categoria = document.getElementById('categoria_id').value;
    
    if (!categoria) {
        e.preventDefault();  // Detener el envÃ­o
        alert('âš ï¸ Debes seleccionar una categorÃ­a');
        return false;
    }
});
</script>
{% endblock %}
```

**3 niveles de validaciÃ³n:**
1. `required` en HTML â†’ El navegador valida
2. JavaScript antes de enviar â†’ ValidaciÃ³n extra
3. Python en el servidor â†’ La definitiva

---

## 4. static/style.css - Los Estilos

### ğŸ¨ Variables CSS

```css
:root {
    --primary-color: #6366f1;    /* Morado/Ãndigo */
    --secondary-color: #8b5cf6;  /* PÃºrpura */
    --success-color: #10b981;    /* Verde */
}
```

**Uso:** `background: var(--primary-color);`

### ğŸ“¦ Estilos de Tarjetas

```css
.card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
}

.card:hover {
    transform: translateY(-5px);  /* Se eleva al pasar mouse */
}
```

### ğŸ­ Animaciones

```css
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);  /* Arriba */
    }
    to {
        opacity: 1;
        transform: translateY(0);      /* PosiciÃ³n normal */
    }
}

.alert {
    animation: slideDown 0.5s ease;
}
```

---

## 5. Flujo Completo: Â¿QuÃ© pasa cuando...?

### ğŸ” Hago login?

```
1. Usuario ingresa datos en login.html
   â†“
2. POST â†’ app.py â†’ def login()
   â†“
3. Usuario.query.filter_by(username=...).first()
   â†“ (busca en database.db)
4. usuario.check_password(password)
   â†“ (compara hash)
5. session['user_id'] = usuario.id
   â†“ (guarda en sesiÃ³n)
6. redirect â†’ home.html
```

### ğŸ’µ Creo un gasto?

```
1. Usuario llena form.html
   â†“
2. JavaScript valida (categorÃ­a no vacÃ­a)
   â†“
3. POST â†’ app.py â†’ def crear_gasto()
   â†“
4. Python valida (categorÃ­a y monto)
   â†“
5. nuevo_gasto = Gasto(...)
   â†“
6. db.session.add(nuevo_gasto)
   â†“
7. db.session.commit() â†’ Guarda en database.db
   â†“
8. redirect â†’ list.html
```

### ğŸ“Š Veo la lista de gastos?

```
1. Usuario hace clic en "Lista"
   â†“
2. GET â†’ app.py â†’ def lista_gastos()
   â†“
3. gastos = Gasto.query.order_by(Gasto.fecha.desc()).all()
   â†“ (consulta a database.db)
4. total = sum(gastos.monto)
   â†“
5. render_template('list.html', gastos=gastos, total=total)
   â†“
6. Jinja2 procesa el HTML
   â†“
7. Navegador muestra la tabla
```

### ğŸ—‘ï¸ Elimino una categorÃ­a?

```
1. Usuario hace clic en "Eliminar"
   â†“
2. confirm() de JavaScript â†’ Â¿Confirmas?
   â†“ (Si dice OK)
3. GET â†’ app.py â†’ def eliminar_categoria(id)
   â†“
4. categoria = Categoria.query.get_or_404(id)
   â†“
5. if categoria.gastos: â†’ ERROR (tiene gastos)
   else: â†’ OK (eliminar)
   â†“
6. db.session.delete(categoria)
   â†“
7. db.session.commit()
   â†“
8. flash('CategorÃ­a eliminada')
   â†“
9. redirect â†’ categorias.html
```

---

## ğŸ¯ Puntos Clave para Explicar

### 1. Las Rutas (app.py)
```python
@app.route('/ruta')  # Define la URL
def funcion():       # CÃ³digo que se ejecuta
    return resultado # Lo que muestra
```

### 2. Las Queries (Consultas a BD)
```python
# Obtener todos
usuarios = Usuario.query.all()

# Buscar por campo
usuario = Usuario.query.filter_by(username='admin').first()

# Obtener por ID
usuario = Usuario.query.get(1)

# Obtener o error 404
usuario = Usuario.query.get_or_404(1)
```

### 3. Sesiones
```python
# Guardar
session['user_id'] = 1

# Leer
user_id = session['user_id']

# Verificar si existe
if 'user_id' in session:
    print("EstÃ¡ logueado")

# Borrar todo
session.clear()
```

### 4. Templates (Jinja2)
```html
<!-- Variables -->
{{ usuario.username }}

<!-- Condicionales -->
{% if usuario %}
    <p>Hola {{ usuario.username }}</p>
{% else %}
    <p>No hay usuario</p>
{% endif %}

<!-- Loops -->
{% for gasto in gastos %}
    <li>{{ gasto.monto }}</li>
{% endfor %}
```

### 5. Formularios
```html
<!-- HTML -->
<form method="POST" action="{{ url_for('crear_gasto') }}">
    <input type="text" name="monto">
    <button type="submit">Enviar</button>
</form>

<!-- Python -->
@app.route('/gastos/crear', methods=['POST'])
def crear_gasto():
    monto = request.form.get('monto')  # Obtiene el valor
    # ... proceso ...
    return redirect(url_for('lista_gastos'))
```

---

## ğŸ’¡ Tips para Entender el CÃ³digo

1. **Empieza por las rutas** - Son las URLs que ves en el navegador
2. **Sigue el flujo** - Usuario â†’ Formulario â†’ Route â†’ BD â†’ Template
3. **Las relaciones son clave** - Usuario tiene muchos Gastos
4. **Session = memoria temporal** - Guarda quiÃ©n estÃ¡ logueado
5. **Flash = mensajes temporales** - Se muestran una sola vez

---

## ğŸ› Errores Comunes y Soluciones

### Error: "Working outside of application context"
**SoluciÃ³n:** Usa `with app.app_context():`

### Error: "No such table: usuarios"
**SoluciÃ³n:** Ejecuta `db.create_all()` dentro de `app_context`

### Error: "TemplateNotFound: home.html"
**SoluciÃ³n:** Verifica que el archivo estÃ© en `templates/home.html`

### Error: "Unauthorized"
**SoluciÃ³n:** Agrega `@login_required` a la ruta

---

## ğŸ“š Resumen Final

| Archivo | QuÃ© hace |
|---------|----------|
| **app.py** | Define rutas, maneja formularios, conecta todo |
| **models.py** | Define tablas (Usuario, Categoria, Gasto) |
| **base.html** | Template base con navbar |
| **form.html** | Formulario para crear gastos |
| **list.html** | Muestra todos los gastos |
| **style.css** | Todos los estilos visuales |

**Flujo bÃ¡sico:**
```
Usuario â†’ HTML â†’ Route â†’ BD â†’ Template â†’ Usuario
```

---
